<ng-container *ngIf="{ 
  todos: todos$ | async,
  isLoading: isLoading$ | async,
  error: error$ | async,
  isSubmittingTodo: isSubmittingTodo$ | async,
  isSubmittingShare: isSubmittingShare$ | async,
  activeTodosCount: activeTodosCount$ | async,
  completedTodosCount: completedTodosCount$ | async
} as vm">
<div class="todo-container">
  <!-- Header -->
  <div class="todo-header">
    <h2 class="todo-title">My Tasks</h2>
    <button class="btn btn-primary" (click)="openCreateModal()">
      <app-icon name="add" size="20" />
      New Todo
    </button>
  </div>

  <!-- Stats -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon"><app-icon name="note" size="32" /></div>
      <div class="stat-content">
        <div class="stat-value">{{ vm.todos?.length || 0 }}</div>
        <div class="stat-label">Total Tasks</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon"><app-icon name="checkmark" size="32" /></div>
      <div class="stat-content">
        <div class="stat-value">{{ vm.completedTodosCount || 0 }}</div>
        <div class="stat-label">Completed</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon"><app-icon name="clock" size="32" /></div>
      <div class="stat-content">
        <div class="stat-value">{{ vm.activeTodosCount || 0 }}</div>
        <div class="stat-label">Active</div>
      </div>
    </div>
  </div>

  <!-- Filters and Search -->
  <div class="filters-section">
    <div class="search-box">
      <span class="search-icon"><app-icon name="search" size="20" /></span>
      <input
        type="text"
        [(ngModel)]="searchQuery"
        (ngModelChange)="onSearchChange()"
        placeholder="Search todos..."
        class="search-input"
      />
    </div>

    <div class="filter-buttons">
      <button
        [class.active]="filterStatus === 'all'"
        (click)="onFilterChange('all')"
        class="filter-btn"
      >
        All
      </button>
      <button
        [class.active]="filterStatus === 'active'"
        (click)="onFilterChange('active')"
        class="filter-btn"
      >
        Active
      </button>
      <button
        [class.active]="filterStatus === 'completed'"
        (click)="onFilterChange('completed')"
        class="filter-btn"
      >
        Completed
      </button>
    </div>
  </div>

  <!-- Info Notice -->
  <div class="info-notice">
    <app-icon name="information" size="20" class="info-icon" />
    <span class="info-text">Check the checkbox to mark a task as completed</span>
  </div>

  <!-- Loading State -->
  @if (vm.isLoading) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Loading your todos...</p>
    </div>
  } @else if (!vm.todos || vm.todos.length === 0) {
    <div class="empty-state">
      <div class="empty-icon"><app-icon name="note" size="64" /></div>
      <h3 class="empty-title">No todos found</h3>
      <p class="empty-description">
        @if (searchQuery) {
          Try adjusting your search query
        } @else if (filterStatus !== 'all') {
          No {{ filterStatus }} todos at the moment
        } @else {
          Get started by creating your first todo!
        }
      </p>
    </div>
  } @else {
    <div class="todos-list">
      @for (todo of vm.todos; track todo.id) {
        <div class="todo-card" [class.completed]="todo.status === 'completed'">
          <div class="todo-checkbox">
            <input
              type="checkbox"
              [checked]="todo.status === 'completed'"
              (change)="toggleComplete(todo)"
              [disabled]="!canEdit(todo)"
              [id]="'todo-' + todo.id"
            />
            <label [for]="'todo-' + todo.id"></label>
          </div>

          <div class="todo-content">
            <div class="todo-header">
              <h3 class="todo-title" [class.completed]="todo.status === 'completed'">
                {{ todo.title }}
              </h3>
              <div class="todo-badges">
                <span class="permission-badge" [class]="getPermissionBadge(todo)">
                  {{ getPermissionBadge(todo) }}
                </span>
                @if (todo.due_at) {
                  <span 
                    class="due-date-badge"
                    [class.due-today]="isDueToday(todo.due_at)"
                    [class.overdue]="isOverdue(todo.due_at)"
                  >
                    <app-icon name="calendar" size="16" /> {{ formatDate(todo.due_at) }}
                  </span>
                }
              </div>
            </div>

            @if (todo.description) {
              <p class="todo-description">{{ todo.description }}</p>
            }

            @if (todo.owner) {
              <div class="todo-meta">
                <span class="owner-info">
                  <app-icon name="user" size="16" /> {{ todo.owner.name }}
                </span>
                @if (todo.is_shared) {
                  <span class="shared-info">
                    <app-icon name="users" size="16" /> Shared
                  </span>
                }
              </div>
            }
          </div>

          <div class="todo-actions">
            @if (canEdit(todo)) {
              <button class="action-btn edit-btn" (click)="openEditModal(todo)" title="Edit">
                <app-icon name="edit" size="18" />
              </button>
            }
            @if (canDelete(todo)) {
              <button class="action-btn share-btn" (click)="openShareModal(todo)" title="Share">
                <app-icon name="share" size="18" />
              </button>
              <button class="action-btn delete-btn" (click)="deleteTodo(todo)" title="Delete">
                <app-icon name="delete" size="18" />
              </button>
            }
          </div>
        </div>
      }
    </div>
  }
</div>

<!-- Todo Modal -->
<app-todo-modal
  [isOpen]="isModalOpen"
  [todo]="editingTodo"
  [isSubmitting]="vm.isSubmittingTodo || false"
  (close)="closeModal()"
  (submit)="onSubmitTodo($event)"
></app-todo-modal>

<!-- Share Todo Modal -->
<app-share-todo-modal
  [isOpen]="isShareModalOpen"
  [todoTitle]="sharingTodo?.title || ''"
  [isSubmitting]="vm.isSubmittingShare || false"
  (close)="closeShareModal()"
  (share)="onShareTodo($event)"
></app-share-todo-modal>
</ng-container>
